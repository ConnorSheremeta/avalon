#!/bin/sh
#
# Usage: locking_runner process_name command arg arg arg...
#

SEMAPHORE=$1
LOCKFILE=tmp/pids/$SEMAPHORE
shift

trap unlock EXIT

unlock()
{
  if [ "$$" -eq `less $LOCKFILE` ]; then # don't remove another process's lock
    rm -f $LOCKFILE 
    exit 255
  fi
}

if [ ! -e $LOCKFILE ]; then
    echo "$$" > $LOCKFILE
    "$@" || true #run the command
fi
